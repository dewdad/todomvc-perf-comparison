!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.link=t()}(this,function(){"use strict";function e(e){return!!e&&"object"==typeof e}function t(e){return"function"==typeof e}function n(e){return["string","number","boolean","null","undefined"].indexOf(typeof e)>-1}function i(e){return"string"==typeof e}function r(e){return"boolean"==typeof e}function o(e){return i(e)&&"{"===e[0]&&"}"===e.slice(-1)}function l(e,t){e.className.indexOf(t)===-1&&(e.className=c(e.className)+" "+t)}function s(e,t){e.className.indexOf(t)>-1&&(e.className=e.className.replace(new RegExp(t,"g"),""))}function a(){if(arguments.length<2)return arguments[0];var e=arguments[0],t=Array.prototype.slice.call(arguments,1);return e.replace(/\{(\d+)\}/g,function(e,n){return t[n]})}function c(e){return"string"==typeof e?e.trim():e}function u(e,t){for(var n=e.length,i=-1;++i<n;)t(e[i],i,e)}function h(e,t){return u(Object.keys(t),function(n){e[n]=t[n]}),e}function f(e,t,n,i){e.addEventListener&&(e.addEventListener(t,n,!1),i.push({el:e,event:t,handler:n}))}function p(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}function d(e,t,n){var i=e[t];if(i)n(i);else{var r=new XMLHttpRequest;r.onreadystatechange=function(){r.readyState===XMLHttpRequest.DONE&&200===r.status&&(e[t]=c(r.responseText),n(r.responseText))},r.open("GET",t,!0),r.setRequestHeader("Accept","text/html"),r.send(null)}}function m(t){if(e(t)){var n,i={};return u(Object.keys(t),function(r){n=t[r],re(n)?(i[r]=[],u(n,function(e){i[r].push(m(e))})):e(n)?i[r]=m(n):i[r]=n}),i}return t}function v(e){if("undefined"==typeof e){var t=location.href,n=t.indexOf("#");return n===-1?"":t.slice(n+1)}location.hash=e}function _(e){var t=location.href,n=t.indexOf("#");n>-1?location.replace(t.slice(0,n)+"#"+e):location.replace(t+"#"+e)}function x(t,n,i){function r(){var r=n[v()];if(!r)return void _(i);r.model&&e(r.model)||(r.model={});var o=c(r.template);o?k(t,r,o):r.templateUrl?d(t._routeTplStore,r.templateUrl,function(e){k(t,r,e)}):k(t,r,"")}f(window,"hashchange",r,t._eventStore),r()}function k(e,n,i){function r(){e._routeEl&&(n.lastLinker=ie({el:e._routeEl,model:n.model,methods:n.methods}),t(n.postLink)&&n.postLink.call(n,n.lastLinker))}var o;if(e._routeEl&&(e._routeEl.innerHTML=i),n.lastLinker&&n.lastLinker.unlink(),t(n.preLink)&&(o=n.preLink.call(n,e)),o&&t(o.then))o.then(r);else{if(o===!1)return;r()}}function y(){var e=a.apply(null,arguments);return new Error(e)}function w(e){if(!Number(e))return e;e+="";var t=[],n="",i=-1,r=[],o=",";(i=e.indexOf("."))>-1?(t=e.slice(0,i).split(""),n=e.slice(i)):t=e.split("");do r.unshift(t.splice(-3).join(""));while(t.length>0);return r.join(o)+n}function b(e){return i(e)&&11===e.length?e.slice(0,3)+"****"+e.slice(-4):e}function g(e,t){return new Function("$this","with($this){return "+e+";}")(t)}function C(e,t,n){var i,r=e.expr,o=e.linker.model;return i=n?t?n.replace(me,function(e,t){return O(t,o)}):g(r,o):t?O(r,o):g(r,o)}function O(e,t){var n=e.split("|");if(1===n.length)return g(e,t);var i=xe[c(n[1])];return i(g(c(n[0]),t))}function A(e){return g(e.expr,e.linker.model)}function N(e,t,r){null===t?t="null":"undefined"==typeof t&&(t="undefined");var o="";if(i(t))o=[e,"=","'",t,"'"].join("");else{if(!n(t))throw y("value should be a primitive type for setWatchValue");o=[e,"=",t].join("")}g(o,r)}function j(e){var t=e.tag;if(!t)throw y("tag is required for a component!");t=t.toUpperCase(),pe.registeredTags[t]||(pe.registeredTags[t]=e,++pe.registeredTagsCount)}function T(e,t){var n=t.config,i=c(n.template),r=t.el;i?L(e,r,n,i):n.templateUrl&&d(e._comTplStore,n.templateUrl,function(t){L(e,r,n,t)})}function E(e,t,n,i){return function(){N(e,g(t,i),n)}}function L(e,n,i,r){var o=m(i.model),l=i.methods||{};if(re(i.props)){var s;u(i.props,function(i){if(s=c(n.getAttribute(i)),t(e.model[s]))l[i]=e.model[s];else{e.watch(s,E(i,s,o,e.model));var r=g(s,e.model);r!==o[i]&&(o[i]=r)}})}if(n.innerHTML=r,n.children.length>1)throw y("component can only have one root element");var a=ie({el:n.children[0],model:o,methods:l});t(i.postLink)&&i.postLink.call(a.model,n,a,i)}function M(e,t){function n(){N(e.prop,i.value||"",e.linker.model)}var i=e.el;f(i,t,n,e.linker._eventStore)}function S(e){function t(){var t,i=n.value,o=n.checked,l=A(e);if(!r(l)&&!re(l))throw y("checkbox should bind with array or a boolean value");re(l)?(t=l.indexOf(i),!o&&t>-1?l.splice(t,1):l.push(i)):N(e.prop,o,e.linker.model)}var n=e.el;f(n,"click",t,e.linker._eventStore)}function $(e){var t=e.el,n=t.nodeName,i=t.type;switch(n){case"INPUT":switch(i){case"text":case"email":case"password":case"url":M(e,"keyup");break;case"radio":M(e,"click");break;case"checkbox":S(e)}break;case"SELECT":M(e,"change");break;default:M(e,"keyup")}}function U(e,t,n){e.el.textContent=C(e,t,n)}function B(e){var t=A(e);e.className?t?l(e.el,e.className):s(e.el,e.className):t&&l(e.el,t)}function z(e){A(e)?e.el.setAttribute("disabled","disabled"):e.el.removeAttribute("disabled")}function H(e){var t=e.el,n=A(e);if("radio"===t.type)t.checked=t.value===n;else if("checkbox"===t.type)if(re(n))t.checked=n.indexOf(t.value)>-1;else{if(!r(n))throw y("checkbox should bind with array or a boolean value");t.checked=n}else t.value!=n&&(t.value=n)}function Z(e){A(e)?e.el.setAttribute("readonly","readonly"):e.el.removeAttribute("readonly")}function q(e,t,n,i){var r,o=e.el.cloneNode(!0),l=e.linker.model,s=Object.create(null);return s.$index={value:n,enumerable:!0,configurable:!0,writable:!0},s[i]={value:t,enumerable:!0,configurable:!0,writable:!0},r=new ge(o,Object.create(l,s)),r._context=e,e.linker._children.push(r),{el:o,linker:r}}function D(e,t){function n(){var t=document.createDocumentFragment();u(s,function(e){e.unlink()}),s.length=0,u(r,function(n,r){i=q(e,n,r,a),s.push(i.linker),t.appendChild(i.el)}),l.parentNode.insertBefore(t,l)}var i,r=g(e.prop,e.linker.model),o=e.el,l=e.comment,s=e.lastLinks,a=e.expr.split(ve)[0];if(s||(s=e.lastLinks=[],l=e.comment=document.createComment("repeat end for "+e.prop),o.parentNode.insertBefore(e.comment,o),o.parentNode.removeChild(o)),t){var c,h,f,p=t.op;switch(p){case"mutate":break;case"push":h=r.length-1,c=r[h],i=q(e,c,h,a),s.push(i.linker),l.parentNode.insertBefore(i.el,l);break;case"pop":f=s.pop(),f.unlink();break;case"splice":f=Array.prototype.splice.apply(s,t.args),u(f,function(e){e.unlink()}),u(s,function(e,t){e.model.$index=t});break;case"unshift":var d=s[0].el;c=r[0],i=q(e,c,0,a),s.unshift(i.linker),d.parentNode.insertBefore(i.el,d);break;case"shift":f=s.shift(),f.unlink();break;default:n()}}else n()}function F(e){var t=e.el,n=e.directive,i=!!A(e);"x-show"===n&&i||"x-hide"===n&&!i?s(t,"x-hide"):l(t,"x-hide")}function R(e){e.linker._watchMap[e.prop].push(W(e))}function P(e,t,n){e.linker._watchMap[e.prop].push(X(e,t,n))}function W(e){return function(t){be[e.directive](e,t)}}function X(e,t,n){return function(){be[e.directive](e,t,n)}}function G(e,n,i){var r=e._watchMap[n];n&&t(i)&&(r||(r=e._watchMap[n]=[]),r.push(i))}function I(e,t){return function(n){var i=t.el,r=t.fn,o=t.args;if(null===r)g(o,e.model);else if(e.model[r])if(re(o)){var l=[n,i],s=[];u(o,function(t){t=c(t),"'"===t.charAt(0)||'"'===t.charAt(0)?s.push(t.replace(ce,"")):s.push(g(t,e.model))}),fe.apply(l,s),e.model[r].apply(e.model,l)}else e.model[r].apply(e.model,[n,i])}}function V(e,t,n){var i=['"',n,'"'].join("").replace(/(\{\{)/g,'"+(').replace(/(\}\})/g,')+"'),r=new we(i);r.run(),r.watches&&u(r.watches,function(o){var l=ke.create(t,o,"x-bind",i,e);e._linkContextCollection.push(l),P(l,r.filters,n)})}function J(e,t,n,i,r){var o=ke.create(t,n,i,r,e);K(e,o)}function K(e,t){e._linkContextCollection.push(t),R(t),"x-model"===t.directive&&$(t)}function Q(e,t,n,i){var r,o,l;le.test(i)?r=ye.create(t,n,i):se.test(i)?(o=i.indexOf("("),r=ye.create(t,n,i.slice(0,o))):ae.test(i)?(l=i.match(ae)[1].split(","),o=i.indexOf("("),r=ye.create(t,n,i.slice(0,o),l)):r=ye.create(t,n,null,i),f(t,n,I(e,r),e._eventStore)}function Y(e,t,n,i){var r,o,l,s,a,c=i.slice(1,-1).split(",");u(c,function(i){l=i.split(":"),r=l[0].replace(ce,"").trim(),o=l[1].trim(),oe.test(o)?(a=ke.create(t,o,n,o,e),a.className=r,K(e,a)):(s=new we(o),s.run(),s.watches&&u(s.watches,function(i){a=ke.create(t,i,n,o,e),a.className=r,K(e,a)}))})}function ee(e,t,n,i){var r;if(oe.test(i))J(e,t,i,n,i);else if(o(i))Y(e,t,n,i);else{var l=new we(i);l.run(),l.watches&&u(l.watches,function(o){r=ke.create(t,o,n,i,e),e._linkContextCollection.push(r),P(r,l.filters)})}}function te(e,t){var n,i,r,o,l,s,a=t.nodeType;if(1===a){if(o=t.hasAttributes()){if(t.hasAttribute("x-repeat")){if(i=c(t.getAttribute("x-repeat")),r=i.split(ve),3!==r.length)throw y("repeat only support expr like: var in array.");return J(e,t,r[2],"x-repeat",i),t.removeAttribute("x-repeat"),void(e._children=[])}if(t.hasAttribute("x-view")){if(e._routeEl)throw y("a link context can only have on more than one x-view");return t.removeAttribute("x-view"),void(e._routeEl=t)}u(t.attributes,function(n){l=n.name,s=c(n.value),"x"===l[0]&&"-"===l[1]?ee(e,t,l,s):l[0]===_e&&Q(e,t,l.slice(1),s)})}if(pe.registeredTagsCount>0&&(n=t.tagName.toUpperCase(),pe.registeredTags[n]))return void e._comCollection.push({el:t,config:pe.registeredTags[n]});u(t.childNodes,function(t){te(e,t)})}else 3===a?(i=c(t.textContent),i&&de.test(i)&&V(e,t,i)):9===a&&u(t.childNodes,function(t){te(e,t)})}function ne(e,t,n){u(["push","pop","unshift","shift","reverse","sort","splice"],function(i){e[i]=function(){var r=Array.prototype[i].apply(e,arguments);return n._notify(t,{op:i,args:arguments}),n._notify(t+".length"),r}})}function ie(e){return e=h({el:window.document,model:{},methods:null,routes:null},e),new ge(e.el,e.model,e.methods,e.routes)}var re=Array.isArray,oe=/^\$?\w+(\.?\w+)*$/,le=/^[a-zA-Z$_]\w*$/,se=/^[a-zA-Z$_]\w*\(\s*\)$/,ae=/^[a-zA-Z$_]\w*\(([^\)]+)\)$/,ce=/[\'\"]/g,ue=/[a-zA-Z$_]/,he=/[a-zA-Z0-9$\.]/,fe=Array.prototype.unshift,pe={registeredTagsCount:0,registeredTags:Object.create(null)},de=/\{\{[^\}]+\}\}/,me=/\{\{([^\}]+)\}\}/g,ve=/\s+/,_e="@",xe={uppercase:function(e){return i(e)?e.toUpperCase():e},lowercase:function(e){return i(e)?e.toLowerCase():e},money:w,phone:b},ke=function(e,t,n,i,r){this.el=e,this.prop=t,this.directive=n,this.expr=i,this.linker=r};ke.create=function(e,t,n,i,r){return r._watchMap[t]||(r._watchMap[t]=[]),new ke(e,t,n,i,r)};var ye=function(e,t,n,i){this.el=e,this.event=t,this.fn=n,this.args=i};ye.create=function(e,t,n,i){return new ye(e,t,n,i)};var we=function(e){this.text=e,this.index=0,this.len=e.length,this.watches=null,this.filters=null};we.prototype.run=function(){for(var e=this;this.index<this.len;){var t=e.text[e.index];if(ue.test(t))e.watches||(e.watches=[]),e._getWatch(t);else if('"'===t||"'"===t){for(;this._peek()!==t&&this.index<this.len;)e.index++;if(!(e.index+1<e.len))throw new Error("unclosed string in expr");e.index+=2}else if("|"===t)if("|"!==e._peek()){if(e.filters||(e.filters=[]),e.index++,e.watches.length<e.filters.length)throw new Error("bad expr");e._getFilter()}else e.index+=2;else e.index++}},we.prototype._getFilter=function(){for(var e=this,t=[this.text[this.index]];this.index<this.len;){if(!he.test(e._peek())){e.index++;break}t.push(e.text[++e.index])}this.filters.push(c(t.join("")))},we.prototype._getWatch=function(e){for(var t=this,n=[e];this.index<this.len;){if(!he.test(t._peek())){t.index++;break}n.push(t.text[++t.index])}this.watches.push(n.join(""))},we.prototype._peek=function(e){return e=e||1,this.index+e<this.len&&this.text[this.index+1]};var be={"x-show":F,"x-hide":F,"x-bind":U,"x-disabled":z,"x-repeat":D,"x-class":B,"x-model":H,"x-readonly":Z},ge=function(e,t,n,i){this.el=e,this.model=t,this._behaviors=n,this._eventStore=[],this._linkContextCollection=[],this._watchMap=Object.create(null),this._routeEl=null,this._comCollection=[],this._unlinked=!1,this._children=null,this._context=null,this._bootstrap(),i&&(this._routeTplStore=Object.create(null),x(this,i.routes,i.defaultPath)),pe.registeredTagsCount>0&&this._comCollection.length>0&&(this._comTplStore=Object.create(null),this._renderComponent())};ge.prototype._bootstrap=function(){var e=this;this._compileDOM(),this._walk(this.model,[]),u(Object.keys(this._watchMap),function(t){e._notify(t)}),this._addBehaviors()},ge.prototype._walk=function(t,n){var i,r,o,l=this;u(Object.keys(t),function(s){i=t[s],r=re(i),e(i)&&!r?(n.push(s),l._walk(i,n),n.pop()):(o=n.concat(s).join("."),l._defineObserver(t,s,i,o,r))})},ge.prototype._defineObserver=function(e,t,n,i,r){var o=this;r&&ne(n,i,o),Object.defineProperty(e,t,{get:function(){return n},set:function(e){if(e!==n){if(n=e,o._unlinked)return;r&&(ne(n,i,o),o._notify(i+".length")),o._notify(i),o._context&&o._context.linker._notify(o._context.prop,{op:"mutate"}),o._children&&u(o._children,function(e){e._unlinked||e._notify(i)})}}})},ge.prototype._addBehaviors=function(){var n=this;if(e(this._behaviors)){var i=Object.keys(this._behaviors);u(i,function(e){if(t(n._behaviors[e])){if(e in n.model&&!t(n.model[e]))throw y('{0} is defined in the data model,please change the function/method name of "{0}"',e);n.model[e]||(n.model[e]=n._behaviors[e])}})}},ge.prototype._renderComponent=function(){var e=this;u(this._comCollection,function(t){T(e,t)})},ge.prototype.watch=function Oe(Oe,e){G(this,Oe,e)},ge.prototype._notify=function(e,t){var n=this._watchMap[e];n&&u(n,function(e){e(t)})},ge.prototype._compileDOM=function(){te(this,this.el)},ge.prototype.unlink=function(){var e=this;if(this._behaviors=null,this._linkContextCollection.length=0,this._watchMap=null,this._routeEl=null,this._comCollection.length=0,this._routeTplStore=null,this._comTplStore=null,u(this._eventStore,function(e){p(e.el,e.event,e.handler)}),this._eventStore.length=0,this._children&&(u(this._children,function(e){e._unlinked||e.unlink()}),this._children.length=0),this._context){for(var t=this._context.linker._children,n=t.length;n--;)t[n]===e&&t.splice(n,1);this._context=null,this.el.parentNode.removeChild(this.el),this.el=null}this.model=null,this._unlinked=!0},ie.helper={addClass:l,removeClass:s,formatString:a,trim:c,each:u,hash:v},ie.filter=function(e,n){!xe[e]&&t(n)&&(xe[e]=n)},ie.com=j;var Ce=document.createElement("style");return Ce.type="text/css",Ce.textContent=".x-hide{display:none !important;}",document.head.insertAdjacentElement("afterBegin",Ce),ie});